<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Produits - FLARE Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 { font-size: 24px; margin-bottom: 5px; }
        .breadcrumb { font-size: 14px; opacity: 0.9; }
        .breadcrumb a { color: white; text-decoration: none; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary { background: white; color: #667eea; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover { background: #38a169; }

        .container { max-width: 1600px; margin: 0 auto; padding: 30px; }

        .products-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* SIDEBAR PRODUITS */
        .products-sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .products-sidebar h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #667eea;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .products-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .product-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
            border: 2px solid transparent;
        }

        .product-item:hover {
            background: #f5f5f5;
        }

        .product-item.active {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-color: #667eea;
        }

        .product-item .name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .product-item .ref {
            font-size: 12px;
            color: #999;
        }

        /* CONTENU PRINCIPAL */
        .product-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .product-header {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px 30px;
            border-bottom: 2px solid #667eea;
        }

        .product-header h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
        }

        .product-header .ref {
            font-size: 14px;
            color: #666;
        }

        /* ONGLETS */
        .tabs {
            display: flex;
            background: #f9f9f9;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* FORMULAIRES */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section h3::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        /* TOGGLE SWITCH */
        .toggle-field {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .toggle-field label {
            margin: 0;
            font-weight: 500;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider { background-color: #667eea; }
        input:checked + .slider:before { transform: translateX(24px); }

        /* COLOR PICKER */
        .colors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .color-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            position: relative;
        }

        .color-preview {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            border: 2px solid #ddd;
            cursor: pointer;
        }

        .color-item input[type="text"] {
            width: 100%;
            padding: 6px;
            text-align: center;
            font-size: 12px;
        }

        .btn-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e53e3e;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .btn-add {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
        }

        /* SIZES GRID */
        .sizes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .size-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .size-checkbox:hover {
            background: #f0f0f0;
        }

        .size-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* OPTIONS PERSONNALIS√âES */
        .option-item {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
        }

        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .option-values {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .value-tag {
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            border: 1px solid #ddd;
        }

        /* ALERT */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.active { display: block; }
        .alert-success { background: #c6f6d5; color: #22543d; border-left: 4px solid #48bb78; }
        .alert-error { background: #fed7d7; color: #742a2a; border-left: 4px solid #e53e3e; }

        /* SAVE BAR */
        .save-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: none;
            justify-content: center;
            gap: 15px;
            z-index: 1000;
        }

        .save-bar.active { display: flex; }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active { display: block; }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div>
            <h1>üì¶ Gestion Compl√®te des Produits</h1>
            <div class="breadcrumb">
                <a href="index.html">Admin</a> > Produits
            </div>
        </div>
        <div>
            <a href="index.html" class="btn btn-primary">‚Üê Retour</a>
        </div>
    </div>

    <div class="container">
        <div class="alert alert-success" id="successAlert">
            ‚úÖ <span id="successMessage"></span>
        </div>
        <div class="alert alert-error" id="errorAlert">
            ‚ùå <span id="errorMessage"></span>
        </div>

        <div class="products-grid">
            <!-- SIDEBAR: LISTE DES PRODUITS -->
            <div class="products-sidebar">
                <h3>üîç Rechercher un produit</h3>
                <div class="search-box">
                    <input type="text" id="searchProduct" placeholder="Nom ou r√©f√©rence..." onkeyup="searchProducts()">
                </div>

                <div class="loading" id="sidebarLoading">
                    <div class="spinner"></div>
                    <p>Chargement...</p>
                </div>

                <div class="products-list" id="productsList">
                    <!-- Rempli dynamiquement -->
                </div>
            </div>

            <!-- CONTENU: FICHE PRODUIT COMPL√àTE -->
            <div class="product-content">
                <div class="empty-state" id="emptyState">
                    <h3>üëà S√©lectionne un produit dans la liste</h3>
                    <p>Toutes les options de configuration appara√Ætront ici</p>
                </div>

                <div id="productDetails" style="display: none;">
                    <div class="product-header">
                        <h2 id="productTitle">Chargement...</h2>
                        <div class="ref" id="productRef"></div>
                    </div>

                    <!-- ONGLETS -->
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('infos')">üìã Infos g√©n√©rales</div>
                        <div class="tab" onclick="switchTab('prix')">üí∞ Prix</div>
                        <div class="tab" onclick="switchTab('configurateur')">üé® Configurateur</div>
                        <div class="tab" onclick="switchTab('contenu')">üìù Contenu</div>
                        <div class="tab" onclick="switchTab('guide')">üìè Guide tailles</div>
                        <div class="tab" onclick="switchTab('similaires')">üîó Produits similaires</div>
                    </div>

                    <!-- CONTENU DES ONGLETS -->
                    <div id="tab-infos" class="tab-content active">
                        <form id="formInfos">
                            <div class="form-section">
                                <h3>Informations de base</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Nom du produit *</label>
                                        <input type="text" id="nom" required>
                                    </div>
                                    <div class="form-group">
                                        <label>R√©f√©rence *</label>
                                        <input type="text" id="reference" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Sport *</label>
                                        <select id="sport" required>
                                            <option value="">S√©lectionner...</option>
                                            <option value="SPORTSWEAR">SPORTSWEAR</option>
                                            <option value="Basketball">Basketball</option>
                                            <option value="Football">Football</option>
                                            <option value="Rugby">Rugby</option>
                                            <option value="Running">Running</option>
                                            <option value="Volleyball">Volleyball</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Famille *</label>
                                        <select id="famille" required>
                                            <option value="">S√©lectionner...</option>
                                            <option value="Maillot">Maillot</option>
                                            <option value="Short">Short</option>
                                            <option value="Veste">Veste</option>
                                            <option value="Polo">Polo</option>
                                            <option value="Pantalon">Pantalon</option>
                                            <option value="Accessoires">Accessoires</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Tissu</label>
                                        <input type="text" id="tissu">
                                    </div>
                                    <div class="form-group">
                                        <label>Grammage</label>
                                        <input type="text" id="grammage">
                                    </div>
                                    <div class="form-group">
                                        <label>Genre</label>
                                        <select id="genre">
                                            <option value="">-</option>
                                            <option value="Homme">Homme</option>
                                            <option value="Femme">Femme</option>
                                            <option value="Mixte">Mixte</option>
                                            <option value="Enfant">Enfant</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea id="description" rows="4"></textarea>
                                </div>
                            </div>

                            <div class="form-section">
                                <h3>Photos du produit</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Photo 1 (URL)</label>
                                        <input type="text" id="photo1">
                                    </div>
                                    <div class="form-group">
                                        <label>Photo 2 (URL)</label>
                                        <input type="text" id="photo2">
                                    </div>
                                    <div class="form-group">
                                        <label>Photo 3 (URL)</label>
                                        <input type="text" id="photo3">
                                    </div>
                                    <div class="form-group">
                                        <label>Photo 4 (URL)</label>
                                        <input type="text" id="photo4">
                                    </div>
                                    <div class="form-group">
                                        <label>Photo 5 (URL)</label>
                                        <input type="text" id="photo5">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div id="tab-prix" class="tab-content">
                        <form id="formPrix">
                            <div class="form-section">
                                <h3>Paliers de prix (‚Ç¨)</h3>
                                <div class="price-grid">
                                    <div class="form-group">
                                        <label>Prix qty 1</label>
                                        <input type="number" id="prix1" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Prix qty 5</label>
                                        <input type="number" id="prix5" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Prix qty 10</label>
                                        <input type="number" id="prix10" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Prix qty 20</label>
                                        <input type="number" id="prix20" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Prix qty 50</label>
                                        <input type="number" id="prix50" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Prix qty 100</label>
                                        <input type="number" id="prix100" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Prix qty 250</label>
                                        <input type="number" id="prix250" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Prix qty 500</label>
                                        <input type="number" id="prix500" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div id="tab-configurateur" class="tab-content">
                        <form id="formConfigurateur">
                            <div class="form-section">
                                <h3>Options g√©n√©rales du configurateur</h3>

                                <div class="toggle-field">
                                    <label>Permettre les couleurs personnalis√©es</label>
                                    <label class="switch">
                                        <input type="checkbox" id="allowColors" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>

                                <div class="toggle-field">
                                    <label>Permettre les logos</label>
                                    <label class="switch">
                                        <input type="checkbox" id="allowLogos" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>

                                <div class="form-group" id="maxLogosGroup">
                                    <label>Nombre maximum de logos</label>
                                    <input type="number" id="maxLogos" value="3" min="0" max="10">
                                </div>

                                <div class="toggle-field">
                                    <label>Permettre les textes</label>
                                    <label class="switch">
                                        <input type="checkbox" id="allowText" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>

                                <div class="toggle-field">
                                    <label>Permettre les num√©ros</label>
                                    <label class="switch">
                                        <input type="checkbox" id="allowNumbers" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-section">
                                <h3>Couleurs disponibles</h3>
                                <p style="color:#666;margin-bottom:15px;">D√©finissez les couleurs que les clients peuvent choisir</p>

                                <div class="colors-grid" id="colorsList">
                                    <!-- Rempli dynamiquement -->
                                </div>

                                <button type="button" class="btn-add" onclick="addColor()">+ Ajouter une couleur</button>
                            </div>

                            <div class="form-section">
                                <h3>Tailles disponibles</h3>
                                <p style="color:#666;margin-bottom:15px;">Cochez les tailles disponibles pour ce produit</p>

                                <div class="sizes-grid" id="sizesList">
                                    <div class="size-checkbox">
                                        <input type="checkbox" id="size_XS" value="XS">
                                        <label for="size_XS">XS</label>
                                    </div>
                                    <div class="size-checkbox">
                                        <input type="checkbox" id="size_S" value="S">
                                        <label for="size_S">S</label>
                                    </div>
                                    <div class="size-checkbox">
                                        <input type="checkbox" id="size_M" value="M">
                                        <label for="size_M">M</label>
                                    </div>
                                    <div class="size-checkbox">
                                        <input type="checkbox" id="size_L" value="L">
                                        <label for="size_L">L</label>
                                    </div>
                                    <div class="size-checkbox">
                                        <input type="checkbox" id="size_XL" value="XL">
                                        <label for="size_XL">XL</label>
                                    </div>
                                    <div class="size-checkbox">
                                        <input type="checkbox" id="size_XXL" value="XXL">
                                        <label for="size_XXL">XXL</label>
                                    </div>
                                    <div class="size-checkbox">
                                        <input type="checkbox" id="size_3XL" value="3XL">
                                        <label for="size_3XL">3XL</label>
                                    </div>
                                    <div class="size-checkbox">
                                        <input type="checkbox" id="size_4XL" value="4XL">
                                        <label for="size_4XL">4XL</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h3>Options personnalis√©es</h3>
                                <p style="color:#666;margin-bottom:15px;">Ajoutez des options sp√©cifiques (col, manches, poches...)</p>

                                <div id="customOptionsList">
                                    <!-- Rempli dynamiquement -->
                                </div>

                                <button type="button" class="btn-add" onclick="addCustomOption()">+ Ajouter une option</button>
                            </div>

                            <div class="form-section">
                                <h3>R√®gles de prix des options</h3>
                                <div class="price-grid">
                                    <div class="form-group">
                                        <label>Prix extra par logo (‚Ç¨)</label>
                                        <input type="number" id="logoExtra" value="5.00" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label>Prix extra par texte (‚Ç¨)</label>
                                        <input type="number" id="textExtra" value="2.00" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label>Prix extra par num√©ro (‚Ç¨)</label>
                                        <input type="number" id="numberExtra" value="3.00" min="0" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label>Prix extra sublimation (‚Ç¨)</label>
                                        <input type="number" id="sublimationExtra" value="0.00" min="0" step="0.01">
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h3>Quantit√©s et d√©lais</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Quantit√© minimum</label>
                                        <input type="number" id="minQuantity" value="1" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label>Quantit√© maximum</label>
                                        <input type="number" id="maxQuantity" value="1000" min="1">
                                    </div>
                                    <div class="form-group">
                                        <label>D√©lai de livraison (jours)</label>
                                        <input type="number" id="leadTime" value="21" min="1">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div id="tab-contenu" class="tab-content">
                        <div class="form-section">
                            <h3>Contenu d√©taill√©</h3>
                            <p style="color:#666;margin-bottom:15px;">G√©rez tout le contenu de la page produit</p>

                            <div class="form-group">
                                <label>Titre de la page</label>
                                <input type="text" id="titrePage">
                            </div>

                            <div class="form-group">
                                <label>Description courte</label>
                                <textarea id="descCourte" rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label>Description longue</label>
                                <textarea id="descLongue" rows="6"></textarea>
                            </div>

                            <div class="form-group">
                                <label>Caract√©ristiques (une par ligne)</label>
                                <textarea id="caracteristiques" rows="5" placeholder="- Caract√©ristique 1&#10;- Caract√©ristique 2&#10;- Caract√©ristique 3"></textarea>
                            </div>

                            <div class="form-group">
                                <label>Composition</label>
                                <textarea id="composition" rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label>Conseils d'entretien</label>
                                <textarea id="entretien" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="tab-guide" class="tab-content">
                        <div class="form-section">
                            <h3>Guide des tailles</h3>
                            <p style="color:#666;margin-bottom:15px;">√Ä venir : √©diteur de tableau des tailles</p>
                        </div>
                    </div>

                    <div id="tab-similaires" class="tab-content">
                        <div class="form-section">
                            <h3>Produits similaires</h3>
                            <p style="color:#666;margin-bottom:15px;">√Ä venir : gestion des produits recommand√©s</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BARRE DE SAUVEGARDE -->
    <div class="save-bar" id="saveBar">
        <button class="btn btn-primary" onclick="cancelChanges()">Annuler</button>
        <button class="btn btn-success" onclick="saveProduct()">üíæ Enregistrer toutes les modifications</button>
    </div>

    <script>
        let currentProductId = null;
        let allProducts = [];
        let hasChanges = false;
        let currentProductData = {};
        let currentConfigData = {};

        // D√©tection des changements
        document.addEventListener('input', () => {
            hasChanges = true;
            document.getElementById('saveBar').classList.add('active');
        });

        document.addEventListener('change', () => {
            hasChanges = true;
            document.getElementById('saveBar').classList.add('active');
        });

        // Charger les produits au d√©marrage
        loadProducts();

        async function loadProducts() {
            document.getElementById('sidebarLoading').classList.add('active');

            try {
                const response = await fetch('/api/products.php?limit=1000');
                const data = await response.json();

                if (data.success && data.products) {
                    allProducts = data.products;
                    displayProductsList(allProducts);
                } else {
                    showError('Erreur chargement produits');
                }
            } catch (error) {
                showError('Erreur r√©seau : ' + error.message);
            } finally {
                document.getElementById('sidebarLoading').classList.remove('active');
            }
        }

        function displayProductsList(products) {
            const list = document.getElementById('productsList');
            list.innerHTML = '';

            if (products.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Aucun produit trouv√©</p>';
                return;
            }

            products.forEach(product => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.innerHTML = `
                    <div class="name">${product.nom || 'Sans nom'}</div>
                    <div class="ref">${product.reference || '-'}</div>
                `;
                item.onclick = () => selectProduct(product.id);
                list.appendChild(item);
            });
        }

        function searchProducts() {
            const query = document.getElementById('searchProduct').value.toLowerCase();

            if (!query) {
                displayProductsList(allProducts);
                return;
            }

            const filtered = allProducts.filter(p =>
                (p.nom || '').toLowerCase().includes(query) ||
                (p.reference || '').toLowerCase().includes(query)
            );

            displayProductsList(filtered);
        }

        async function selectProduct(productId) {
            if (hasChanges) {
                if (!confirm('Vous avez des modifications non sauvegard√©es. Continuer ?')) {
                    return;
                }
            }

            currentProductId = productId;

            // Highlight dans la liste
            document.querySelectorAll('.product-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Afficher le contenu
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('productDetails').style.display = 'block';

            // Charger les donn√©es
            await loadProductData(productId);
            await loadProductConfig(productId);

            hasChanges = false;
            document.getElementById('saveBar').classList.remove('active');
        }

        async function loadProductData(productId) {
            try {
                const response = await fetch(`/api/products.php?id=${productId}`);
                const data = await response.json();

                if (data.success && data.product) {
                    currentProductData = data.product;
                    populateProductForm(data.product);
                }
            } catch (error) {
                showError('Erreur chargement produit');
            }
        }

        function populateProductForm(product) {
            // Header
            document.getElementById('productTitle').textContent = product.nom || 'Sans nom';
            document.getElementById('productRef').textContent = 'R√©f√©rence : ' + (product.reference || '-');

            // Infos
            document.getElementById('nom').value = product.nom || '';
            document.getElementById('reference').value = product.reference || '';
            document.getElementById('sport').value = product.sport || '';
            document.getElementById('famille').value = product.famille || '';
            document.getElementById('tissu').value = product.tissu || '';
            document.getElementById('grammage').value = product.grammage || '';
            document.getElementById('genre').value = product.genre || '';
            document.getElementById('description').value = product.description || '';

            // Photos
            document.getElementById('photo1').value = product.photo_1 || '';
            document.getElementById('photo2').value = product.photo_2 || '';
            document.getElementById('photo3').value = product.photo_3 || '';
            document.getElementById('photo4').value = product.photo_4 || '';
            document.getElementById('photo5').value = product.photo_5 || '';

            // Prix
            document.getElementById('prix1').value = product.prix_1 || 0;
            document.getElementById('prix5').value = product.prix_5 || 0;
            document.getElementById('prix10').value = product.prix_10 || 0;
            document.getElementById('prix20').value = product.prix_20 || 0;
            document.getElementById('prix50').value = product.prix_50 || 0;
            document.getElementById('prix100').value = product.prix_100 || 0;
            document.getElementById('prix250').value = product.prix_250 || 0;
            document.getElementById('prix500').value = product.prix_500 || 0;
        }

        async function loadProductConfig(productId) {
            try {
                const response = await fetch(`/api/configurator-data.php?action=product&id=${productId}`);
                const data = await response.json();

                if (data.success && data.data.config) {
                    currentConfigData = data.data.config;
                    populateConfigForm(data.data.config);
                }
            } catch (error) {
                console.error('Erreur chargement config:', error);
                // Utiliser config par d√©faut
                populateConfigForm({});
            }
        }

        function populateConfigForm(config) {
            // Options g√©n√©rales
            document.getElementById('allowColors').checked = config.allow_colors !== false;
            document.getElementById('allowLogos').checked = config.allow_logos !== false;
            document.getElementById('maxLogos').value = config.max_logos || 3;
            document.getElementById('allowText').checked = config.allow_text !== false;
            document.getElementById('allowNumbers').checked = config.allow_numbers !== false;

            // Couleurs
            displayColors(config.colors || ['#FFFFFF', '#000000', '#FF0000', '#0000FF', '#FFFF00', '#00FF00']);

            // Tailles
            const sizes = config.available_sizes || ['S', 'M', 'L', 'XL'];
            document.querySelectorAll('.size-checkbox input[type="checkbox"]').forEach(cb => {
                cb.checked = sizes.includes(cb.value);
            });

            // Options personnalis√©es
            displayCustomOptions(config.custom_options || []);

            // Prix
            const priceRules = config.price_rules || {};
            document.getElementById('logoExtra').value = priceRules.logo_extra || 5.00;
            document.getElementById('textExtra').value = priceRules.text_extra || 2.00;
            document.getElementById('numberExtra').value = priceRules.number_extra || 3.00;
            document.getElementById('sublimationExtra').value = priceRules.sublimation_extra || 0.00;

            // Quantit√©s
            document.getElementById('minQuantity').value = config.min_quantity || 1;
            document.getElementById('maxQuantity').value = config.max_quantity || 1000;
            document.getElementById('leadTime').value = config.lead_time_days || 21;
        }

        function displayColors(colors) {
            const container = document.getElementById('colorsList');
            container.innerHTML = '';

            colors.forEach((color, index) => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                colorItem.innerHTML = `
                    <input type="color" class="color-preview" value="${color}" onchange="updateColor(${index}, this.value)">
                    <input type="text" value="${color}" onchange="updateColorHex(${index}, this.value)">
                    <button class="btn-remove" onclick="removeColor(${index})">√ó</button>
                `;
                container.appendChild(colorItem);
            });
        }

        function addColor() {
            const container = document.getElementById('colorsList');
            const colors = Array.from(container.querySelectorAll('input[type="text"]')).map(input => input.value);
            colors.push('#000000');
            displayColors(colors);
            hasChanges = true;
            document.getElementById('saveBar').classList.add('active');
        }

        function removeColor(index) {
            const container = document.getElementById('colorsList');
            const colors = Array.from(container.querySelectorAll('input[type="text"]')).map(input => input.value);
            colors.splice(index, 1);
            displayColors(colors);
            hasChanges = true;
            document.getElementById('saveBar').classList.add('active');
        }

        function updateColor(index, value) {
            const inputs = document.querySelectorAll('#colorsList input[type="text"]');
            inputs[index].value = value;
            hasChanges = true;
            document.getElementById('saveBar').classList.add('active');
        }

        function updateColorHex(index, value) {
            const inputs = document.querySelectorAll('#colorsList input[type="color"]');
            inputs[index].value = value;
            hasChanges = true;
            document.getElementById('saveBar').classList.add('active');
        }

        function displayCustomOptions(options) {
            const container = document.getElementById('customOptionsList');
            container.innerHTML = '';

            options.forEach((option, index) => {
                const optionItem = document.createElement('div');
                optionItem.className = 'option-item';
                optionItem.innerHTML = `
                    <div class="option-header">
                        <input type="text" value="${option.label}" placeholder="Nom de l'option (ex: Col)" style="flex:1;margin-right:10px;" onchange="markChanged()">
                        <button class="btn-remove" onclick="removeCustomOption(${index})">Supprimer</button>
                    </div>
                    <input type="text" placeholder="Valeurs s√©par√©es par des virgules" value="${option.values ? option.values.join(', ') : ''}" onchange="markChanged()" style="width:100%;">
                    <div class="option-values">
                        ${option.values ? option.values.map(v => `<span class="value-tag">${v}</span>`).join('') : ''}
                    </div>
                `;
                container.appendChild(optionItem);
            });
        }

        function addCustomOption() {
            const container = document.getElementById('customOptionsList');
            const options = getCurrentCustomOptions();
            options.push({ label: '', values: [] });
            displayCustomOptions(options);
            markChanged();
        }

        function removeCustomOption(index) {
            const options = getCurrentCustomOptions();
            options.splice(index, 1);
            displayCustomOptions(options);
            markChanged();
        }

        function getCurrentCustomOptions() {
            const container = document.getElementById('customOptionsList');
            const options = [];
            Array.from(container.children).forEach(item => {
                const label = item.querySelector('input[type="text"]').value;
                const valuesInput = item.querySelectorAll('input[type="text"]')[1].value;
                const values = valuesInput.split(',').map(v => v.trim()).filter(v => v);
                if (label || values.length > 0) {
                    options.push({ label, values });
                }
            });
            return options;
        }

        function markChanged() {
            hasChanges = true;
            document.getElementById('saveBar').classList.add('active');
        }

        function switchTab(tabName) {
            // D√©sactiver tous les onglets
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Activer l'onglet cliqu√©
            event.currentTarget.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        async function saveProduct() {
            if (!currentProductId) return;

            // Collecter toutes les donn√©es
            const productData = {
                nom: document.getElementById('nom').value,
                reference: document.getElementById('reference').value,
                sport: document.getElementById('sport').value,
                famille: document.getElementById('famille').value,
                tissu: document.getElementById('tissu').value,
                grammage: document.getElementById('grammage').value,
                genre: document.getElementById('genre').value,
                description: document.getElementById('description').value,
                photo_1: document.getElementById('photo1').value,
                photo_2: document.getElementById('photo2').value,
                photo_3: document.getElementById('photo3').value,
                photo_4: document.getElementById('photo4').value,
                photo_5: document.getElementById('photo5').value,
                prix_1: parseFloat(document.getElementById('prix1').value) || 0,
                prix_5: parseFloat(document.getElementById('prix5').value) || 0,
                prix_10: parseFloat(document.getElementById('prix10').value) || 0,
                prix_20: parseFloat(document.getElementById('prix20').value) || 0,
                prix_50: parseFloat(document.getElementById('prix50').value) || 0,
                prix_100: parseFloat(document.getElementById('prix100').value) || 0,
                prix_250: parseFloat(document.getElementById('prix250').value) || 0,
                prix_500: parseFloat(document.getElementById('prix500').value) || 0
            };

            const configData = {
                allow_colors: document.getElementById('allowColors').checked,
                colors: Array.from(document.querySelectorAll('#colorsList input[type="text"]')).map(input => input.value),
                allow_logos: document.getElementById('allowLogos').checked,
                max_logos: parseInt(document.getElementById('maxLogos').value),
                allow_text: document.getElementById('allowText').checked,
                allow_numbers: document.getElementById('allowNumbers').checked,
                available_sizes: Array.from(document.querySelectorAll('.size-checkbox input:checked')).map(cb => cb.value),
                custom_options: getCurrentCustomOptions(),
                price_rules: {
                    logo_extra: parseFloat(document.getElementById('logoExtra').value),
                    text_extra: parseFloat(document.getElementById('textExtra').value),
                    number_extra: parseFloat(document.getElementById('numberExtra').value),
                    sublimation_extra: parseFloat(document.getElementById('sublimationExtra').value)
                },
                min_quantity: parseInt(document.getElementById('minQuantity').value),
                max_quantity: parseInt(document.getElementById('maxQuantity').value),
                lead_time_days: parseInt(document.getElementById('leadTime').value)
            };

            try {
                // Sauvegarder le produit
                const prodResponse = await fetch(`/api/products.php?id=${currentProductId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                const prodData = await prodResponse.json();

                if (!prodData.success) {
                    showError('Erreur sauvegarde produit : ' + (prodData.error || 'Inconnue'));
                    return;
                }

                // Sauvegarder la config
                const configResponse = await fetch(`/api/product-config.php?product_id=${currentProductId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });

                const configResult = await configResponse.json();

                if (configResult.success) {
                    showSuccess('‚úÖ Toutes les modifications ont √©t√© sauvegard√©es !');
                    hasChanges = false;
                    document.getElementById('saveBar').classList.remove('active');

                    // Recharger les donn√©es
                    await loadProductData(currentProductId);
                    await loadProductConfig(currentProductId);
                } else {
                    showError('Erreur sauvegarde config : ' + (configResult.error || 'Inconnue'));
                }

            } catch (error) {
                showError('Erreur r√©seau : ' + error.message);
            }
        }

        function cancelChanges() {
            if (currentProductId) {
                loadProductData(currentProductId);
                loadProductConfig(currentProductId);
            }
            hasChanges = false;
            document.getElementById('saveBar').classList.remove('active');
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const alert = document.getElementById('successAlert');
            alert.classList.add('active');
            setTimeout(() => alert.classList.remove('active'), 3000);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const alert = document.getElementById('errorAlert');
            alert.classList.add('active');
            setTimeout(() => alert.classList.remove('active'), 5000);
        }
    </script>
</body>
</html>
