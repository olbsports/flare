<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioth√®que M√©dias - FLARE Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .breadcrumb { font-size: 14px; opacity: 0.9; }

        .header-actions { display: flex; gap: 10px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: white; color: #667eea; }
        .btn-success { background: #48bb78; color: white; }
        .btn-danger { background: #e53e3e; color: white; }
        .btn:hover { transform: translateY(-2px); }

        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }

        .filters-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 15px;
        }

        .filters-bar input, .filters-bar select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 { font-size: 32px; color: #667eea; margin-bottom: 5px; }
        .stat-card p { color: #666; font-size: 14px; }

        .upload-zone {
            background: white;
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover { background: #f8f9ff; }
        .upload-zone.dragover { background: #e6eaff; border-color: #764ba2; }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .media-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .media-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .media-preview {
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            overflow: hidden;
        }

        .media-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-preview.pdf {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            font-size: 48px;
        }

        .media-preview.svg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 48px;
        }

        .media-info {
            padding: 12px;
        }

        .media-name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .media-details {
            font-size: 11px;
            color: #666;
        }

        .media-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: none;
            gap: 5px;
        }

        .media-card:hover .media-actions {
            display: flex;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active { display: flex; align-items: center; justify-content: center; }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 { font-size: 20px; }
        .close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }

        .modal-body { padding: 30px; }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .preview-container {
            text-align: center;
        }

        .preview-container img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .info-group {
            margin-bottom: 20px;
        }

        .info-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-group input, .info-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .copy-url {
            display: flex;
            gap: 10px;
        }

        .copy-url input {
            flex: 1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.active { display: block; }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.active { display: block; }
        .alert-success { background: #c6f6d5; color: #22543d; border-left: 4px solid #48bb78; }
        .alert-error { background: #fed7d7; color: #742a2a; border-left: 4px solid #e53e3e; }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
        }

        #fileInput { display: none; }
    </style>
</head>
<body>
    <div class="admin-header">
        <div>
            <h1>Biblioth√®que M√©dias</h1>
            <div class="breadcrumb"><a href="index.html" style="color: white;">Admin</a> > M√©dias</div>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="location.href='index.html'">‚Üê Retour</button>
            <button class="btn btn-success" onclick="document.getElementById('fileInput').click()">+ Upload fichier</button>
        </div>
    </div>

    <div class="container">
        <div class="alert alert-success" id="successAlert"><span id="successMessage"></span></div>
        <div class="alert alert-error" id="errorAlert"><span id="errorMessage"></span></div>

        <!-- Statistiques -->
        <div class="stats-bar">
            <div class="stat-card">
                <h3 id="totalFiles">-</h3>
                <p>Total fichiers</p>
            </div>
            <div class="stat-card">
                <h3 id="totalImages">-</h3>
                <p>Images</p>
            </div>
            <div class="stat-card">
                <h3 id="totalPdfs">-</h3>
                <p>Documents PDF</p>
            </div>
            <div class="stat-card">
                <h3 id="totalSize">-</h3>
                <p>Espace utilis√©</p>
            </div>
        </div>

        <!-- Zone d'upload -->
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
            <h3 style="margin-bottom: 10px;">Glissez vos fichiers ici</h3>
            <p style="color: #666;">ou cliquez pour s√©lectionner (Images, PDF, SVG)</p>
            <input type="file" id="fileInput" multiple accept="image/*,.pdf,.svg">
        </div>

        <!-- Filtres -->
        <div class="filters-bar">
            <input type="text" id="searchInput" placeholder="üîç Rechercher par nom...">
            <select id="typeFilter">
                <option value="">Tous les types</option>
                <option value="image">Images</option>
                <option value="pdf">PDF</option>
                <option value="svg">SVG</option>
            </select>
            <button class="btn btn-primary" onclick="loadMedia()">Filtrer</button>
        </div>

        <!-- Grille de m√©dias -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Chargement des m√©dias...</p>
        </div>

        <div class="media-grid" id="mediaGrid"></div>

        <div class="pagination" id="pagination"></div>
    </div>

    <!-- Modal D√©tails -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>D√©tails du m√©dia</h2>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="preview-container" id="previewContainer">
                        <!-- Preview dynamique -->
                    </div>
                    <div>
                        <div class="info-group">
                            <label>Nom du fichier</label>
                            <input type="text" id="fileName" readonly>
                        </div>
                        <div class="info-group">
                            <label>Type</label>
                            <input type="text" id="fileType" readonly>
                        </div>
                        <div class="info-group">
                            <label>Taille</label>
                            <input type="text" id="fileSize" readonly>
                        </div>
                        <div class="info-group">
                            <label>Dimensions</label>
                            <input type="text" id="fileDimensions" readonly>
                        </div>
                        <div class="info-group">
                            <label>URL</label>
                            <div class="copy-url">
                                <input type="text" id="fileUrl" readonly>
                                <button class="btn btn-primary btn-sm" onclick="copyUrl()">üìã Copier</button>
                            </div>
                        </div>
                        <div class="info-group">
                            <label>Texte alternatif</label>
                            <input type="text" id="fileAlt" placeholder="Description pour accessibilit√©">
                        </div>
                        <div class="info-group">
                            <label>Titre</label>
                            <input type="text" id="fileTitle" placeholder="Titre du m√©dia">
                        </div>
                        <div class="info-group">
                            <label>Description</label>
                            <textarea id="fileDescription" rows="3" placeholder="Description..."></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button class="btn btn-danger" onclick="deleteMedia()">üóëÔ∏è Supprimer</button>
                            <button class="btn btn-success" onclick="updateMedia()">üíæ Enregistrer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        const perPage = 30;
        let currentMediaId = null;

        // Charger les m√©dias
        async function loadMedia(page = 1) {
            document.getElementById('loading').classList.add('active');

            const search = document.getElementById('searchInput').value;
            const type = document.getElementById('typeFilter').value;

            try {
                let url = `/api/media.php?page=${page}&limit=${perPage}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (type) url += `&type=${encodeURIComponent(type)}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    displayMedia(data.media || []);
                    updatePagination(data.pagination);
                    updateStats(data.media || []);
                } else {
                    showError(data.error || 'Erreur chargement');
                }
            } catch (error) {
                showError('Erreur r√©seau: ' + error.message);
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // Afficher les m√©dias
        function displayMedia(media) {
            const grid = document.getElementById('mediaGrid');
            grid.innerHTML = '';

            if (media.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">Aucun m√©dia trouv√©</div>';
                return;
            }

            media.forEach(item => {
                const card = document.createElement('div');
                card.className = 'media-card';
                card.onclick = () => showDetails(item);

                const preview = createPreview(item);

                card.innerHTML = `
                    ${preview}
                    <div class="media-actions">
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); confirmDelete(${item.id}, '${item.filename}')">üóëÔ∏è</button>
                    </div>
                    <div class="media-info">
                        <div class="media-name" title="${item.filename}">${item.filename}</div>
                        <div class="media-details">${formatSize(item.size)} ‚Ä¢ ${item.mime_type}</div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Cr√©er preview
        function createPreview(item) {
            if (item.mime_type.startsWith('image/')) {
                return `<div class="media-preview"><img src="${item.url}" alt="${item.filename}"></div>`;
            } else if (item.mime_type === 'application/pdf') {
                return `<div class="media-preview pdf">üìÑ</div>`;
            } else if (item.mime_type === 'image/svg+xml') {
                return `<div class="media-preview svg">üé®</div>`;
            }
            return `<div class="media-preview">üìé</div>`;
        }

        // Afficher d√©tails
        function showDetails(item) {
            currentMediaId = item.id;
            document.getElementById('detailModal').classList.add('active');

            document.getElementById('fileName').value = item.filename;
            document.getElementById('fileType').value = item.mime_type;
            document.getElementById('fileSize').value = formatSize(item.size);
            document.getElementById('fileDimensions').value = item.width && item.height ? `${item.width} √ó ${item.height} px` : 'N/A';
            document.getElementById('fileUrl').value = window.location.origin + item.url;
            document.getElementById('fileAlt').value = item.alt_text || '';
            document.getElementById('fileTitle').value = item.title || '';
            document.getElementById('fileDescription').value = item.description || '';

            const previewContainer = document.getElementById('previewContainer');
            if (item.mime_type.startsWith('image/')) {
                previewContainer.innerHTML = `<img src="${item.url}" alt="${item.filename}" style="max-width: 100%; border-radius: 10px;">`;
            } else if (item.mime_type === 'application/pdf') {
                previewContainer.innerHTML = `<div style="font-size: 120px; color: #e53e3e;">üìÑ</div><p>${item.filename}</p>`;
            } else {
                previewContainer.innerHTML = `<div style="font-size: 120px; color: #667eea;">üìé</div><p>${item.filename}</p>`;
            }
        }

        // Mettre √† jour m√©dia
        async function updateMedia() {
            if (!currentMediaId) return;

            const data = {
                alt_text: document.getElementById('fileAlt').value,
                title: document.getElementById('fileTitle').value,
                description: document.getElementById('fileDescription').value
            };

            try {
                const response = await fetch(`/api/media.php?id=${currentMediaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess('M√©dia mis √† jour');
                    closeModal();
                    loadMedia(currentPage);
                } else {
                    showError(result.error || 'Erreur mise √† jour');
                }
            } catch (error) {
                showError('Erreur r√©seau');
            }
        }

        // Supprimer m√©dia
        function confirmDelete(id, name) {
            if (!confirm(`Supprimer le fichier "${name}" ?\n\nCette action est irr√©versible.`)) return;
            deleteMediaById(id);
        }

        async function deleteMedia() {
            if (!currentMediaId) return;
            closeModal();
            deleteMediaById(currentMediaId);
        }

        async function deleteMediaById(id) {
            try {
                const response = await fetch(`/api/media.php?id=${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showSuccess('M√©dia supprim√©');
                    loadMedia(currentPage);
                } else {
                    showError(data.error || 'Erreur suppression');
                }
            } catch (error) {
                showError('Erreur r√©seau');
            }
        }

        // Upload fichiers
        async function uploadFiles(files) {
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/api/media.php', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        showSuccess(`${file.name} upload√©`);
                    } else {
                        showError(`${file.name}: ${data.error}`);
                    }
                } catch (error) {
                    showError(`${file.name}: Erreur upload`);
                }
            }

            loadMedia(currentPage);
        }

        // Drag & Drop
        const uploadZone = document.getElementById('uploadZone');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            uploadFiles(Array.from(e.dataTransfer.files));
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            uploadFiles(Array.from(e.target.files));
        });

        // Copier URL
        function copyUrl() {
            const input = document.getElementById('fileUrl');
            input.select();
            document.execCommand('copy');
            showSuccess('URL copi√©e dans le presse-papiers');
        }

        // Pagination
        function updatePagination(pagination) {
            currentPage = pagination.page;
            totalPages = pagination.pages;

            const container = document.getElementById('pagination');
            container.innerHTML = '';

            if (totalPages <= 1) return;

            if (currentPage > 1) {
                const btn = document.createElement('button');
                btn.textContent = '‚Üê Pr√©c√©dent';
                btn.onclick = () => loadMedia(currentPage - 1);
                container.appendChild(btn);
            }

            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = i === currentPage ? 'active' : '';
                btn.onclick = () => loadMedia(i);
                container.appendChild(btn);
            }

            if (currentPage < totalPages) {
                const btn = document.createElement('button');
                btn.textContent = 'Suivant ‚Üí';
                btn.onclick = () => loadMedia(currentPage + 1);
                container.appendChild(btn);
            }
        }

        // Statistiques
        function updateStats(media) {
            document.getElementById('totalFiles').textContent = media.length;

            const images = media.filter(m => m.mime_type.startsWith('image/')).length;
            const pdfs = media.filter(m => m.mime_type === 'application/pdf').length;
            const totalSize = media.reduce((sum, m) => sum + parseInt(m.size || 0), 0);

            document.getElementById('totalImages').textContent = images;
            document.getElementById('totalPdfs').textContent = pdfs;
            document.getElementById('totalSize').textContent = formatSize(totalSize);
        }

        // Utilitaires
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const alert = document.getElementById('successAlert');
            alert.classList.add('active');
            setTimeout(() => alert.classList.remove('active'), 3000);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const alert = document.getElementById('errorAlert');
            alert.classList.add('active');
            setTimeout(() => alert.classList.remove('active'), 5000);
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadMedia();
        });

        // Init
        loadMedia();
    </script>
</body>
</html>
